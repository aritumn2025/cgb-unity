# 2024-XX-XX Unity 側 WebSocket 対応メモ

## 変更概要
- `Assets/HubGameClient.cs` を新規追加し、ゲーム側から Hub (`/ws`) へ常駐接続する WebSocket クライアントを実装。
- `Assets/MiniJSON.cs`（MiniJSON ベースの軽量パーサ）を追加し、受信 JSON をディクショナリとして扱えるようにした。
- `Assets/target.cs` に `TryApplyRemoteInput()` を追加し、`p1`〜`p4` の入力を WebSocket から取り出して移動／射撃へ反映。接続が無い場合は従来のキーボード判定にフォールバック。
- `.gitignore` に対する変更はなし（新規追加ファイルはいずれもトラッキング対象内）。

## HubGameClient.cs 概要
- デフォルト URL は `ws://127.0.0.1:8765/ws`。環境変数 `CGB_HUB_URL` で上書き可能。
- 接続時に `{"role":"game"}` を送信し、以降 `type: "state"` メッセージを受信してプレイヤー毎の最新状態を保持。
- 接続断は 1.0s から最大 4.0s の指数バックオフで自動再接続。
- 状態は `stateStaleAfterSeconds`（既定 3 秒）を過ぎると破棄。`TryGetState(id, out snapshot)` で参照。
- メインスレッドとのやり取りは最小限にするため、バックグラウンドで受信し `Update()` 内でログ出力とステートの掃除を実施。

## target.cs の入力適用
- `AxisDeadzone` を 0.25 に設定し、スティック値が閾値を超えた場合のみ移動キー相当を発火。
- `btn.a` が `true` の場合に射撃 (`KeySettings(0)`) を連続評価。従来同様 `FixedUpdate` の周期で連射制御。
- `HubGameClient` が未初期化／切断／タイムアウトの場合は従来のキーボード入力ロジックへ自動フォールバックするため、デバッグモードや CPU 操作の挙動は従来通り。

## 今後の検討ポイント
- ボタン種別が増えた際は `TryApplyRemoteInput()` 内のマッピングを拡張する（`btn` の追加キーに合わせて分岐を追加）。
- スティックのデッドゾーンや加速度のチューニングはゲームバランスに応じて `AxisDeadzone` を調整。
- 受信メッセージを Unity Input System へブリッジする場合は `HubGameClient` からイベントを発火する層を追加する。
